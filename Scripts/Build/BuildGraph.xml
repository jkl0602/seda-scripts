<?xml version='1.0'?>
<BuildGraph xmlns="http://www.epicgames.com/BuildGraph">

    <!-- Environment Variables and Options -->
    <Option Name="GamePath" DefaultValue="C:\Jenkins\agent_root\workspace\ShippingBuild\ElpisClient"
        Description="Path to the .uproject file (directory or full path)" />
    <Option Name="EnginePath" DefaultValue="C:\Program Files\Epic Games\UE_5.7"
        Description="Path to the Unreal Engine directory" />
    <Option Name="OutputDir" DefaultValue="C:\Elpis\Shipping\Out"
        Description="Root output directory for artifacts" />
    <Option Name="BuildNumber" DefaultValue="0" Description="Build number for versioning" />
    <Option Name="Clean" DefaultValue="false" Description="Whether to clean build" />
    <Option Name="IniOverrides" DefaultValue="" Description="Additional INI overrides" />

    <!-- Arguments for RunUAT -->
    <Property Name="UAT" Value="$(EnginePath)/Build/BatchFiles/RunUAT.bat" />
    <Property Name="EditorCmd" Value="$(EnginePath)/Binaries/Win64/UnrealEditor-Cmd.exe" />
    <Property Name="ProjectFile" Value="$(GamePath)/Elpis.uproject" />

    <Agent Name="BuildAgent" Type="Win64">

        <!-- 1. Init Data Table -->
        <Node Name="InitData">
            <Spawn Exe="$(EditorCmd)"
                Arguments="$(ProjectFile) -run=InitDataTableCommandlet -SCCProvider=None" />
        </Node>

        <!-- 2. Cook, Stage, Pak, Archive -->
        <!-- 2. Cook, Stage, Pak, Archive -->
        <Node Name="BuildCookRun" Requires="InitData">
            <!-- 1. Compile: Required to generate Elpis.exe -->
            <Compile Target="Elpis" Platform="Win64" Configuration="Shipping"
                Arguments="-Project=$(ProjectFile)" />

            <!-- 2. Cook: Generate Content -->
            <!-- Native BuildGraph Cook Task -->
            <Cook Project="$(ProjectFile)" Platform="Windows"
                Arguments="-clientconfig=Shipping -serverconfig=Shipping -noP4 -iterate -maps=/Game/Covenant/BG/Level/Sector/LV_Sector_01.umap -pak" />

            <!-- 4. Stage: Copy binaries and paks to StagingDirectory -->
            <!-- Stage requires Target (e.g. 'Elpis') and ToDir -->
            <Stage Project="$(ProjectFile)" Platform="Windows" Configuration="Shipping"
                Target="Elpis"
                ToDir="$(GamePath)/Saved/StagedBuilds/" />

            <!-- Copy to OutputDir -->
            <Copy From="$(GamePath)/Saved/StagedBuilds/..." To="$(OutputDir)/Windows/" />
        </Node>

        <!-- 3. Upload Sentry Symbols -->
        <Node Name="UploadSymbols" Requires="BuildCookRun">
            <!-- Log in and Upload -->
            <Spawn
                Exe="$(GamePath)/Plugins/Sentry/Source/ThirdParty/CLI/sentry-cli-Windows-x86_64.exe"
                Arguments="login --auth-token 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" />
            <Spawn
                Exe="$(GamePath)/Plugins/Sentry/Source/ThirdParty/CLI/sentry-cli-Windows-x86_64.exe"
                Arguments="debug-files upload -o seconddive -p covenant-dev $(GamePath)/Binaries/Win64" />
        </Node>

        <!-- 4. Finalize Artifacts (Rename and Zip) -->
        <Node Name="PackageArtifacts" Requires="BuildCookRun;UploadSymbols">
            <!-- BuildCookRun archives to $(OutputDir)/Windows (or similar). The original script
            renamed Windows to Elpis. -->
            <!-- We assume $(OutputDir)/Windows exists. Rename it to Elpis. -->
            <Spawn Exe="cmd.exe" Arguments="/c ren &quot;$(OutputDir)\Windows&quot; Elpis" />

            <!-- Copy version.txt if it exists in GamePath -->
            <Copy From="$(GamePath)/version.txt" To="$(OutputDir)/Elpis/version.txt" />

            <!-- Zip -->
            <Zip FromDir="$(OutputDir)/Elpis" ZipFile="$(OutputDir)/$(BuildNumber).zip" />
        </Node>

    </Agent>

</BuildGraph>